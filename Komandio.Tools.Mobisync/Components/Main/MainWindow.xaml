<ui:FluentWindow x:Class="Komandio.Tools.Mobisync.Components.Main.MainWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
        xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
        xmlns:ui="http://schemas.lepo.co/wpfui/2022/xaml"
        xmlns:converters="clr-namespace:Komandio.Tools.Mobisync.Converters"
        xmlns:dashboard="clr-namespace:Komandio.Tools.Mobisync.Components.Dashboard"
        xmlns:processors="clr-namespace:Komandio.Tools.Mobisync.Components.Processors"
        xmlns:areas="clr-namespace:Komandio.Tools.Mobisync.Components.Areas"
        xmlns:kills="clr-namespace:Komandio.Tools.Mobisync.Components.Kills"
        xmlns:contracts="clr-namespace:Komandio.Tools.Mobisync.Components.Contracts"
        xmlns:intel="clr-namespace:Komandio.Tools.Mobisync.Components.SystemIntel"
        xmlns:main="clr-namespace:Komandio.Tools.Mobisync.Components.Main"
        xmlns:vehicles="clr-namespace:Komandio.Tools.Mobisync.Components.Vehicles"
        mc:Ignorable="d"
        x:Name="RootWindow"
        d:DataContext="{d:DesignInstance main:MainViewModel, IsDesignTimeCreatable=False}"
        ui:Design.Background="{DynamicResource ApplicationBackgroundBrush}"
        Title="Komandio Mobisync - Telemetry Interface" Height="850" Width="1280" MinWidth="1024" MinHeight="640"
        ExtendsContentIntoTitleBar="True" WindowBackdropType="Mica" WindowCornerPreference="Default"
        Background="{StaticResource MainBackgroundBrush}" Foreground="{StaticResource TextMainBrush}"
        WindowStartupLocation="Manual">
    
    <Window.Resources>
        <converters:BooleanToVisibilityConverter x:Key="BoolToVis"/>
        <converters:EnumToVisibilityConverter x:Key="EnumToVis"/>

        <Style x:Key="EventCountBadgeStyle" TargetType="ui:InfoBadge">
            <Setter Property="Background" Value="#1a1c24"/>
            <Setter Property="Foreground" Value="#475569"/>
            <Setter Property="FontWeight" Value="Bold"/>
            <Setter Property="FontSize" Value="8.5"/>
            <Setter Property="Padding" Value="5,1"/>
            <Setter Property="VerticalAlignment" Value="Center"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="ui:InfoBadge">
                        <Border Background="{TemplateBinding Background}" 
                                CornerRadius="4" 
                                Padding="{TemplateBinding Padding}"
                                BorderThickness="0">
                            <TextBlock Text="{TemplateBinding Value}" 
                                       Foreground="{TemplateBinding Foreground}"
                                       FontSize="{TemplateBinding FontSize}"
                                       FontWeight="{TemplateBinding FontWeight}"
                                       HorizontalAlignment="Center"
                                       VerticalAlignment="Center"/>
                        </Border>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
            <Style.Triggers>
                <DataTrigger Binding="{Binding IsSelected, RelativeSource={RelativeSource Mode=FindAncestor, AncestorType={x:Type ui:NavigationViewItem}}}" Value="True">
                    <Setter Property="Background" Value="#2563eb"/>
                    <Setter Property="Foreground" Value="White"/>
                </DataTrigger>
            </Style.Triggers>
        </Style>

        <!-- ViewModel to View Mapping -->
        <DataTemplate DataType="{x:Type dashboard:DashboardViewModel}">
            <dashboard:DashboardView />
        </DataTemplate>
        <DataTemplate DataType="{x:Type processors:ProcessorsViewModel}">
            <processors:ProcessorsView />
        </DataTemplate>
        <DataTemplate DataType="{x:Type areas:AreasViewModel}">
            <areas:AreasView />
        </DataTemplate>
        <DataTemplate DataType="{x:Type kills:KillsViewModel}">
            <kills:KillsView />
        </DataTemplate>
        <DataTemplate DataType="{x:Type vehicles:VehiclesViewModel}">
            <vehicles:VehiclesView />
        </DataTemplate>
        <DataTemplate DataType="{x:Type contracts:ContractsViewModel}">
            <contracts:ContractsView />
        </DataTemplate>
        <DataTemplate DataType="{x:Type intel:SystemIntelViewModel}">
            <intel:SystemIntelView />
        </DataTemplate>
    </Window.Resources>

    <Grid Background="{StaticResource WindowBackgroundBrush}">
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
        </Grid.RowDefinitions>

        <ui:TitleBar Grid.Row="0" ShowMaximize="True" ShowMinimize="True" />

        <!-- Custom Title Overlay to bypass Type constraints and match Sketch exactly -->
        <StackPanel Grid.Row="0" Orientation="Horizontal" VerticalAlignment="Center" Margin="16,0,0,0" IsHitTestVisible="False">
            <!-- Lucide Activity Icon -->
            <Path Data="M22,12 L18,12 L15,21 L9,3 L6,12 L2,12" 
                  Stroke="{StaticResource AccentBlueBrush}" 
                  StrokeThickness="2" 
                  StrokeStartLineCap="Round" 
                  StrokeEndLineCap="Round" 
                  StrokeLineJoin="Round"
                  Width="12" Height="12" 
                  Stretch="Uniform" 
                  VerticalAlignment="Center"/>
            
            <!-- App Title -->
            <TextBlock Text="Komandio Mobisync â€” Telemetry Interface" 
                       FontSize="11" 
                       FontWeight="SemiBold" 
                       Foreground="#94a3b8" 
                       Margin="8,0,0,0" 
                       VerticalAlignment="Center"/>
        </StackPanel>

        <Grid Grid.Row="1">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="Auto"/>
                <ColumnDefinition Width="*"/>
            </Grid.ColumnDefinitions>

            <!-- Sidebar -->
            <Border Grid.Column="0" BorderBrush="{StaticResource BorderBrush}" BorderThickness="0,0,0.5,0">
                <Border.Resources>
                    <SolidColorBrush x:Key="NavigationViewItemForeground" Color="#64748b"/>
                    <SolidColorBrush x:Key="NavigationViewItemForegroundPointerOver" Color="#cbd5e1"/>
                    <SolidColorBrush x:Key="NavigationViewItemForegroundPressed" Color="#ffffff"/>
                    <SolidColorBrush x:Key="NavigationViewItemForegroundSelected" Color="#ffffff"/>
                    <SolidColorBrush x:Key="NavigationViewItemForegroundSelectedPointerOver" Color="#ffffff"/>

                    <SolidColorBrush x:Key="NavigationViewItemIconForeground" Color="#64748b"/>
                    <SolidColorBrush x:Key="NavigationViewItemIconForegroundPointerOver" Color="#cbd5e1"/>
                    <SolidColorBrush x:Key="NavigationViewItemIconForegroundPressed" Color="#3b82f6"/>
                    <SolidColorBrush x:Key="NavigationViewItemIconForegroundSelected" Color="#3b82f6"/>
                    <SolidColorBrush x:Key="NavigationViewItemIconForegroundSelectedPointerOver" Color="#3b82f6"/>
                </Border.Resources>
                <ui:NavigationView PaneDisplayMode="Left" OpenPaneLength="220" IsBackButtonVisible="Collapsed" IsPaneToggleVisible="False" HeaderVisibility="Collapsed">
                <ui:NavigationView.PaneHeader>
                    <StackPanel Margin="24,24,0,24">
                        <StackPanel Orientation="Horizontal">
                            <TextBlock Text="MOBISYNC" FontSize="16" FontWeight="Black" Foreground="{StaticResource TextMainBrush}"/>
                            <TextBlock Text="V1.0" FontSize="14" FontWeight="Black" Foreground="{StaticResource AccentBlueBrush}" Margin="8,0,0,0"/>
                        </StackPanel>
                        <TextBlock Text="POWERED BY KOMANDIO" FontSize="9" FontWeight="Black" Foreground="#603b82f6" Margin="0,2,0,0" Typography.Capitals="AllSmallCaps" />
                    </StackPanel>
                </ui:NavigationView.PaneHeader>
                <ui:NavigationView.MenuItems>
                    <ui:NavigationViewItem Icon="{ui:SymbolIcon Symbol=Grid24}" Content="DASHBOARD" Command="{Binding ChangeViewCommand}" CommandParameter="DASHBOARD">
                        <ui:NavigationViewItem.InfoBadge>
                            <ui:InfoBadge Value="{Binding DataContext.AllCount, ElementName=RootWindow}" Style="{StaticResource EventCountBadgeStyle}" />
                        </ui:NavigationViewItem.InfoBadge>
                    </ui:NavigationViewItem>
                    <ui:NavigationViewItemSeparator/>
                    <TextBlock Text="LIVE MODULES" FontSize="10" FontWeight="Black" Foreground="{StaticResource TextSlateBrush}" Margin="24,12,0,12"/>
                    <ui:NavigationViewItem Icon="{ui:SymbolIcon Symbol=Location24}" Content="AREAS" Command="{Binding ChangeViewCommand}" CommandParameter="AREAS">
                        <ui:NavigationViewItem.InfoBadge>
                            <ui:InfoBadge Value="{Binding DataContext.AreasCount, ElementName=RootWindow}" Style="{StaticResource EventCountBadgeStyle}" />
                        </ui:NavigationViewItem.InfoBadge>
                    </ui:NavigationViewItem>
                    <ui:NavigationViewItem Icon="{ui:SymbolIcon Symbol=Target24}" Content="KILLS" Command="{Binding ChangeViewCommand}" CommandParameter="KILLS">
                        <ui:NavigationViewItem.InfoBadge>
                            <ui:InfoBadge Value="{Binding DataContext.KillsCount, ElementName=RootWindow}" Style="{StaticResource EventCountBadgeStyle}" />
                        </ui:NavigationViewItem.InfoBadge>
                    </ui:NavigationViewItem>
                    <ui:NavigationViewItem Icon="{ui:SymbolIcon Symbol=VehicleBus24}" Content="VEHICLES" Command="{Binding ChangeViewCommand}" CommandParameter="VEHICLES">
                        <ui:NavigationViewItem.InfoBadge>
                            <ui:InfoBadge Value="{Binding DataContext.VehiclesCount, ElementName=RootWindow}" Style="{StaticResource EventCountBadgeStyle}" />
                        </ui:NavigationViewItem.InfoBadge>
                    </ui:NavigationViewItem>
                    <ui:NavigationViewItem Icon="{ui:SymbolIcon Symbol=ClipboardTask24}" Content="CONTRACTS" Command="{Binding ChangeViewCommand}" CommandParameter="CONTRACTS">
                        <ui:NavigationViewItem.InfoBadge>
                            <ui:InfoBadge Value="{Binding DataContext.ContractsCount, ElementName=RootWindow}" Style="{StaticResource EventCountBadgeStyle}" />
                        </ui:NavigationViewItem.InfoBadge>
                    </ui:NavigationViewItem>
                    <ui:NavigationViewItemSeparator/>
                    <TextBlock Text="ENVIRONMENT" FontSize="10" FontWeight="Black" Foreground="{StaticResource TextSlateBrush}" Margin="24,12,0,12"/>
                    <ui:NavigationViewItem Icon="{ui:SymbolIcon Symbol=DeveloperBoard24}" Content="SYSTEM INTEL" Command="{Binding ChangeViewCommand}" CommandParameter="SYSTEM">
                        <!-- No badge for System Intel -->
                    </ui:NavigationViewItem>
                    <ui:NavigationViewItem Icon="{ui:SymbolIcon Symbol=Settings24}" Content="PROCESSORS" Command="{Binding ChangeViewCommand}" CommandParameter="PROCESSORS">
                    </ui:NavigationViewItem>
                </ui:NavigationView.MenuItems>
                <ui:NavigationView.PaneFooter>
                    <Border BorderBrush="#1AFFFFFF" BorderThickness="0,1,0,0" Padding="12">
                        <Button Click="OpenWebsite_Click" 
                                Background="Transparent" 
                                BorderBrush="Transparent"
                                Padding="9"
                                HorizontalContentAlignment="Stretch">
                            <Button.Template>
                                <ControlTemplate TargetType="Button">
                                    <Border x:Name="CardBorder" 
                                            Background="{TemplateBinding Background}" 
                                            BorderBrush="{TemplateBinding BorderBrush}" 
                                            BorderThickness="1" 
                                            CornerRadius="8" 
                                            Padding="{TemplateBinding Padding}">
                                        <Grid>
                                            <Grid.RowDefinitions>
                                                <RowDefinition Height="Auto"/>
                                                <RowDefinition Height="Auto"/>
                                            </Grid.RowDefinitions>

                                            <!-- Row 1: Label + Status -->
                                            <Grid Grid.Row="0" Margin="0,0,0,8">
                                                <Grid.ColumnDefinitions>
                                                    <ColumnDefinition Width="*"/>
                                                    <ColumnDefinition Width="Auto"/>
                                                </Grid.ColumnDefinitions>
                                                
                                                <TextBlock x:Name="EcoText" 
                                                           Text="PLATFORM ECOSYSTEM" 
                                                           FontSize="9" 
                                                           FontWeight="Black" 
                                                           Foreground="#64748b" 
                                                           Typography.Capitals="AllSmallCaps"/>

                                                <StackPanel Grid.Column="1" Orientation="Horizontal" VerticalAlignment="Center">
                                                    <Ellipse Width="4" Height="4" Fill="#10b981" Margin="32,0,4,0">
                                                        <Ellipse.Triggers>
                                                            <EventTrigger RoutedEvent="Loaded">
                                                                <BeginStoryboard>
                                                                    <Storyboard>
                                                                        <DoubleAnimation Storyboard.TargetProperty="Opacity" 
                                                                                         From="1.0" To="0.4" 
                                                                                         Duration="0:0:1" 
                                                                                         AutoReverse="True" 
                                                                                         RepeatBehavior="Forever"/>
                                                                    </Storyboard>
                                                                </BeginStoryboard>
                                                            </EventTrigger>
                                                        </Ellipse.Triggers>
                                                    </Ellipse>
                                                    <TextBlock Text="Active" 
                                                               FontSize="9" 
                                                               FontWeight="Bold" 
                                                               Foreground="#cc10b981"
                                                               VerticalAlignment="Center"
                                                               Typography.Capitals="AllSmallCaps"/>
                                                </StackPanel>
                                            </Grid>

                                            <!-- Row 2: Link + Icon -->
                                            <Grid Grid.Row="1">
                                                <Grid.ColumnDefinitions>
                                                    <ColumnDefinition Width="*"/>
                                                    <ColumnDefinition Width="Auto"/>
                                                </Grid.ColumnDefinitions>

                                                <StackPanel Orientation="Horizontal" VerticalAlignment="Center">
                                                    <ui:SymbolIcon x:Name="GlobeIcon" Symbol="Globe24" FontSize="11" Foreground="#64748b" Margin="0,0,8,0"/>
                                                    <TextBlock x:Name="LinkText" 
                                                               Text="KOMANDIO.COM" 
                                                               FontSize="10" 
                                                               FontWeight="Black" 
                                                               Foreground="#94a3b8"/>
                                                </StackPanel>

                                                <ui:SymbolIcon x:Name="ArrowIcon" 
                                                               Grid.Column="1" 
                                                               Symbol="ArrowUpRight24" 
                                                               FontSize="9" 
                                                               Foreground="#3b82f6" 
                                                               Opacity="0"/>
                                            </Grid>
                                        </Grid>
                                    </Border>
                                    <ControlTemplate.Triggers>
                                        <Trigger Property="IsMouseOver" Value="True">
                                            <Setter TargetName="CardBorder" Property="Background" Value="#1A1e3a8a"/> <!-- Blue-900/10 -->
                                            <Setter TargetName="CardBorder" Property="BorderBrush" Value="#661e3a8a"/> <!-- Blue-900/40 -->
                                            <Setter TargetName="EcoText" Property="Foreground" Value="#60a5fa"/> <!-- Blue-400 -->
                                            <Setter TargetName="GlobeIcon" Property="Foreground" Value="#3b82f6"/> <!-- Blue-500 -->
                                            <Setter TargetName="LinkText" Property="Foreground" Value="#f1f5f9"/> <!-- Slate-100 -->
                                            <Setter TargetName="ArrowIcon" Property="Opacity" Value="1"/>
                                        </Trigger>
                                    </ControlTemplate.Triggers>
                                </ControlTemplate>
                            </Button.Template>
                        </Button>
                    </Border>
                </ui:NavigationView.PaneFooter>
            </ui:NavigationView>
            </Border>

            <!-- Content Area -->
            <Grid Grid.Column="1" Margin="32">
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="*"/>
                </Grid.RowDefinitions>

                <!-- Header Shell Part -->
                <Grid Grid.Row="0" Margin="0,0,0,32">
                    <TextBlock VerticalAlignment="Center" Text="{Binding CurrentViewName, StringFormat='/\{0\}', FallbackValue=/DASHBOARD}" FontSize="14" FontFamily="Consolas" Foreground="{StaticResource AccentBlueBrush}" />
                    
                    <StackPanel Orientation="Horizontal" HorizontalAlignment="Right">
                        <!-- Dynamic Status Indicator (Main Header) -->
                        <StackPanel Orientation="Horizontal" Margin="0,0,24,0" VerticalAlignment="Center"
                                    Visibility="{Binding IsRunning, Converter={StaticResource BoolToVis}, FallbackValue=Collapsed}">
                            <ui:SymbolIcon Symbol="ArrowSync24" Foreground="{StaticResource AccentBlueBrush}" FontSize="14" Margin="0,0,8,0"
                                           RenderTransformOrigin="0.5,0.5">
                                <ui:SymbolIcon.RenderTransform>
                                    <RotateTransform Angle="0"/>
                                </ui:SymbolIcon.RenderTransform>
                                <ui:SymbolIcon.Style>
                                    <Style TargetType="ui:SymbolIcon">
                                        <Style.Triggers>
                                            <DataTrigger Binding="{Binding IsRunning}" Value="True">
                                                <DataTrigger.EnterActions>
                                                    <BeginStoryboard>
                                                        <Storyboard>
                                                            <DoubleAnimation Storyboard.TargetProperty="(UIElement.RenderTransform).(RotateTransform.Angle)"
                                                                             From="0" To="360" Duration="0:0:1" RepeatBehavior="Forever"/>
                                                        </Storyboard>
                                                    </BeginStoryboard>
                                                </DataTrigger.EnterActions>
                                            </DataTrigger>
                                        </Style.Triggers>
                                    </Style>
                                </ui:SymbolIcon.Style>
                            </ui:SymbolIcon>
                            
                            <StackPanel VerticalAlignment="Center">
                                <TextBlock Text="ANALYZING STREAM" FontSize="10" FontWeight="Black" Foreground="{StaticResource TextSlateBrush}"/>
                                <TextBlock Text="{Binding ProcessedCount, StringFormat={}{0:N0} LOGS}" FontSize="11" FontFamily="Consolas" Foreground="{StaticResource AccentBlueBrush}" FontWeight="Bold"/>
                            </StackPanel>

                            <Border Width="80" Height="2" Background="#1a334155" CornerRadius="1" Margin="12,0,0,0" VerticalAlignment="Center">
                                <Border HorizontalAlignment="Left" Background="{StaticResource AccentBlueBrush}" CornerRadius="1">
                                    <Border.Style>
                                        <Style TargetType="Border">
                                            <Setter Property="Width" Value="0"/>
                                            <Style.Triggers>
                                                <DataTrigger Binding="{Binding IsCatchingUp}" Value="True">
                                                    <Setter Property="Width" Value="{Binding CatchUpProgress}"/>
                                                </DataTrigger>
                                            </Style.Triggers>
                                        </Style>
                                    </Border.Style>
                                </Border>
                            </Border>
                        </StackPanel>

                        <ui:Button Command="{Binding ToggleMonitorCommand}" 
                                   IsEnabled="{Binding CanStartMonitoring}"
                                   Padding="20,6" CornerRadius="6" FontWeight="Bold" FontSize="11">
                            <ui:Button.Style>
                                <Style TargetType="ui:Button" BasedOn="{StaticResource {x:Type ui:Button}}">
                                    <Style.Triggers>
                                        <DataTrigger Binding="{Binding IsRunning}" Value="True">
                                            <Setter Property="Content" Value="STOP MONITORING"/>
                                            <Setter Property="Background" Value="#1aef4444"/>
                                            <Setter Property="Foreground" Value="#ef4444"/>
                                            <Setter Property="BorderBrush" Value="#4def4444"/>
                                        </DataTrigger>
                                        <DataTrigger Binding="{Binding IsRunning}" Value="False">
                                            <Setter Property="Content" Value="START MONITORING"/>
                                            <Setter Property="Background" Value="{StaticResource AccentBlueBrush}"/>
                                            <Setter Property="Foreground" Value="White"/>
                                        </DataTrigger>
                                    </Style.Triggers>
                                </Style>
                            </ui:Button.Style>
                        </ui:Button>
                    </StackPanel>
                </Grid>

                <ContentControl Grid.Row="1" Content="{Binding CurrentView}" />
            </Grid>
        </Grid>
    </Grid>
</ui:FluentWindow>
